<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/hardware-icons.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-behaviors/paper-button-behavior.html">
<link rel="import" href="../paper-behaviors/paper-ripple-behavior.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-card/paper-card.html">

<script src="../numeral/min/numeral.min.js"></script>
<script src="iso-639-1_flags.js"></script>

<!--
A webcomponent written with Polymer to list Twitch and (in future) Youtube streams. You will be able to filter the results by a specific game and define priority for a selected language.

Example:

    <streaming-list lang="pt" game="Dota 2"></streaming-list>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="streaming-list">
  <link rel="import" type="css" href="../flag-icon-css/css/flag-icon.min.css">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

      paper-card {
        cursor: pointer;
        margin-bottom: 8px;
        max-width: 320px;
        @apply(--streaming-paper-card);
      }

      paper-card.white {
        --paper-card-header-color: #fff;
      }

      paper-card .card-content {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      paper-card .card-content > .vertical {
        padding: 8px;
        white-space: nowrap;
        overflow: hidden;
      }

      paper-card .card-content .vertical {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }

      paper-card::shadow .game, paper-card::shadow .title, paper-card::shadow .viewers {
        overflow: hidden;
        text-overflow: ellipsis;
        -o-text-overflow: ellipsis;
        -ms-text-overflow: ellipsis;
      }

      paper-card .card-content .title {
        @apply(--paper-font-headline);
      }

      .game, .viewers {
        color: var(--paper-grey-600);
        margin-left: 4px;
      }

      .game a {
        color: var(--paper-grey-600);
        text-decoration: none;
      }

      .game a:hover {
        color: var(--paper-grey-800);
      }

      paper-icon-button {
        width: 64px;
        height: 64px;
      }

      paper-icon-button::shadow img {
        border-radius: 50%;
      }
    </style>
    <iron-ajax
               id="ajax"
               auto
               url="{{apiUrl}}"
               handle-as="json"
               last-response="{{response}}"
               debounce-duration="300"
               params='{{_concatParams(limit, lang, game)}}'></iron-ajax>
    <template is="dom-repeat" items="[[response.streams]]">
      <paper-card
                  heading="[[_formatStatus(item.channel.status)]]"
                  image="[[item.preview.medium]]"
                  class="white"
                  on-tap="_onTap"
                  url="[[item._links.self]]"
                  >
        <div class="card-content">
          <paper-icon-button src="[[item.channel.logo]]" title="Go to the channel"></paper-icon-button>
          <div class="vertical">
            <div class="layout horizontal">
              <span class="title flex">[[item.channel.display_name]]</span>
              <span class$="[[_formatFlag(item.channel.language)]]" title$="[[_formatLanguage(item.channel.language)]]"></span>
            </div>
            <div class="layout horizontal center">
              <iron-icon class="game" icon="hardware:videogame-asset"></iron-icon>
              <span class="game"><a href="[[_gameUrl(item.channel.game)]]" title="View more streams from this game" target="_blank">[[item.channel.game]]</a></span>
            </div>
            <div class="layout horizontal center">
              <iron-icon class="viewers" icon="icons:visibility"></iron-icon>
              <span class="viewers">[[_formatViewers(item.viewers)]]</span>
            </div>
          </div>
        </div>
      </paper-card>
    </template>
  </template>

  <script>
    Polymer({
      is: "streaming-list",

      /**
       * Fired when a request is sent.
       *
       * @event request
       */

      /**
       * Fired when a response is received.
       *
       * @event response
       */

      /**
       * Fired when an error is received.
       *
       * @event error
       */

      properties: {
        /**
         * `apiUrl` indicates the URL of twitch API to list streams
         */
        apiUrl: {
          type: String,
          value: "https://api.twitch.tv/kraken/streams"
        },

        /**
         * `limit` Used to define the number of itens in the list
         */
        limit: {
          type: Number,
          value: 5
        },

        /**
         * `lang` Used to filter the language of the videos
         */
        lang: {
          type: String,
          value: "en"
        },

        /**
         * `game` Used to filter videos from a specific game
         */
        game: {
          type: String,
          default: null
        },

        /**
        * `response` The data retrieved from the server
        */
        response: {
          type: Object,
          value: {streams: []},
          notify: true
        }
      },

      listeners: {
        'ajax.request': '_onRequest',
        'ajax.response': '_onResponse',
        'ajax.error': '_onError'
      },

      _concatParams: function(limit, lang, game) {
        return JSON.stringfy({limit: limit, language: lang, game: game});
      },

      _formatLanguage: function(language, isFlag) {
        language = language.replace(/\-.*$/, '');
        var filtered = languages.filter(function(item){
          return item.code === language;
        });

        if(filtered.length < 1 || !filtered[0].flag) {
          console.log('[streaming-list] Flag not found for language code', language, 'please report to upstream opening an issue');
          return null;
        }

        if(isFlag) {
          return 'flag-icon flag-icon-' + filtered[0].flag;
        }

        return filtered[0].name;
      },

      _formatFlag: function(language) {
        return this._formatLanguage(language, true);
      },

      _formatViewers: function(views) {
        return numeral(views).format('0.0a') + ' viewers';
      },

      _formatStatus: function(status) {
        var cut = status.substr(0, 40)
        if (status.length > cut.length) {
          cut += '...';
        }
        return cut;
      },

      _gameUrl: function(game) {
        return 'https://www.twitch.tv/directory/game/' + encodeURI(game);
      },

      _onRequest: function(event) {
        this.fire('request', event);
      },

      _onResponse: function(event) {
        this.fire('response', event);
      },

      _onError: function(event) {
        this.fire('error', event);
      },

      _onTap: function(event) {
        console.log(event);
      },

      /**
       * Performs an AJAX request to the streaming server
       * @returns {!IronRequestElement} Returns !IronRequestElement
       */
      generateRequest() {
        return this.$.ajax.generateRequest();
      }
    });
  </script>
</dom-module>
