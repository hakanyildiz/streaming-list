<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="twitchtv-card.html">

<!--
A webcomponent written with Polymer to list Twitch and (in future) Youtube streams. You will be able to filter the results by a specific game and define priority for a selected language.

Example:

    <streaming-list lang="pt" game="Dota 2"></streaming-list>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="streaming-list">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        @apply(--layout-vertical);
      }

      twitchtv-card {
        margin: 16px;
      }
    </style>
    <iron-ajax
               id="ajax"
               auto
               url="{{apiUrl}}"
               headers='[[_concatHeaders(clientId)]]'
               handle-as="json"
               last-response="{{response}}"
               debounce-duration="30"
               params='[[_concatParams(limit, lang, game)]]'>
    </iron-ajax>
    <template is="dom-repeat" items="[[response.streams]]">
      <twitchtv-card data="[[item]]" width="[[width]]"></twitchtv-card>
    </template>
  </template>

  <script>
    Polymer({
      is: "streaming-list",

      /**
       * Fired when a request is sent.
       *
       * @event streaming-list-request
       */

      /**
       * Fired when a response is received.
       *
       * @event streaming-list-response
       */

      /**
       * Fired in request or response error.
       *
       * @event streaming-list-error
       */

      properties: {
        /**
         * `apiUrl` indicates the URL of twitch API to list streams
         */
        apiUrl: {
          type: String,
          notify: true,
          value: "https://api.twitch.tv/kraken/streams"
        },

        /**
         * `clientId` Required Twitch.tv Client ID (register yout app at https://www.twitch.tv/settings/connections)
         */
        clientId: String,

        /**
         * `limit` Used to define the number of itens in the list
         */
        limit: {
          type: Number,
          notify: true,
          value: 25
        },

        /**
        * `width` If you define width (in pixels) the container layout will be changed to wrap and the card size will be fixed with the given width
        */
        width: {
          type: Number,
          notify: true,
          value: null
        },

        /**
         * `lang` Used to filter the language of the videos
         */
        lang: {
          type: String,
          notify: true,
          value: "en"
        },

        /**
         * `game` Used to filter videos from a specific game
         */
        game: {
          type: String,
          notify: true,
          value: null
        },

        /**
        * `response` The data retrieved from the server
        */
        response: {
          type: Object,
          value: function(){
            return {streams: []}
          },
          notify: true
        }

      },

      listeners: {
        'iron-ajax-request': '_onRequest',
        'iron-ajax-response': '_onResponse',
        'iron-ajax-error': '_onError'
      },

      ready: function(){
        if(this.width) {
          this.className = 'layout horizontal wrap';
        }
      },

      _concatHeaders: function(clientId) {
        return {
          'Client-ID': clientId
        };
      },

      _concatParams: function(limit, lang, game) {
        return {limit: limit, language: lang, game: game};
      },

      _onRequest: function(event) {
        this.fire('streaming-list-request', event);
      },

      _onResponse: function(event) {
        this.fire('streaming-list-response', event);
      },

      _onError: function(event) {
        this.fire('streaming-list-error', event);
      },

      /**
       * Performs an AJAX iron-ajax-request to the streaming server
       * @returns {!IronRequestElement} Returns !IronRequestElement
       */
      generateRequest: function() {
        return this.$.ajax.generateRequest();
      }
    });
  </script>
</dom-module>
